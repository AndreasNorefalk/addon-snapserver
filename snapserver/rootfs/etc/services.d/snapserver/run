#!/command/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Snapcaster
# ==============================================================================
declare streams
declare buffer
declare codec
declare muted
declare sampleformat
declare http
declare tcp
declare logging
declare threads
declare datadir

mkdir -p /share/snapfifo
mkdir -p /share/snapcast

config=/etc/snapserver.conf

if ! bashio::fs.file_exists '/etc/snapserver.conf'; then
    touch /etc/snapserver.conf ||
        bashio::exit.nok "Could not create snapserver.conf file on filesystem"
fi
bashio::log.info "Populating snapserver.conf..."

# Streams
streams=$(bashio::config 'streams')
sed "/[stream]/a $(streams)" "${config}"
# Buffer
buffer=$(bashio::config 'buffer')
sed -i "/#buffer = 1000/a buffer = $(bufffer)" "${config}"
# Codec
codec=$(bashio::config 'codec')
sed -i "/#codec = flac/a codec = $(codec)" "${config}"
# Muted
muted=$(bashio::config 'send_to_muted')
sed -i "/#send_to_muted = false/a codec = $(muted)" "${config}"
# Sampleformat
sampleformat=$(bashio::config 'sampleformat')
sed -i "/#sampleformat = 48000:16:2/a codec = $(sampleformat)" "${config}"
# Http
http=$(bashio::config 'http_enabled')
sed "/[http]/a enabled = $(http)" "${config}"
sed -i "/#bind_to_address = 0.0.0.0/a bind_to_address = ::" "${config}"
# TCP
tcp=$(bashio::config 'tcp_enabled')
sed "/[TCP]/a enabled = $(TCP)" "${config}"
# Logging
logging=$(bashio::config 'logging_enabled')
sed "/[logging]/a debug = $(logging)" "${config}"
# Threads
threads=$(bashio::config 'server_threads')
sed -i "/#threads = -1/a threads = $(threads)" "${config}"
# Datadir
datadir=$(bashio::config 'server_datadir')
sed -i "/#datadir =/a datadir = $(datadir)" "${config}"

# Run snapcaster
bashio::log.info "Starting SnapServer..."
exec snapcaster
